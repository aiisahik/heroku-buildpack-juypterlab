#!/usr/bin/env bash
#
set -eo pipefail

indent() {
  sed -u 's/^/       /'
}



echo "-----> Retrieve environment variables"


BUILD_DIR=$1
# CACHE_DIR=$2
ENV_DIR=$3

mkdir -p "$1" "$2"
build=$(cd "$1/" && pwd)
cache=$(cd "$2/" && pwd)


cd $build
echo "-----> Adding jupyterlab-dash ..."
git clone https://github.com/plotly/jupyterlab-dash
cd jupyterlab-dash
npm install
npm run build
jupyter labextension link .
cd .. 
echo "-----> Starting nbextension step..."
jupyter contrib nbextension install --user
jupyter nbextensions_configurator enable --user
jupyter labextension install @jupyterlab/git
jupyter serverextension enable --py jupyterlab_git

# echo "------> Trying to print GITHUB_TOKEN  from env_dir"
# echo $GITHUB_TOKEN | indent


if [ -f "$ENV_DIR/GITHUB_URL" ]; then
  echo "-----> GITHUB_URL detected. Setting up GIT ..."
  GITHUB_URL=$(cat "$ENV_DIR/GITHUB_URL")
  mkdir -p "$build/notebooks"
  cd $build/notebooks
  git init
  git remote add origin $GITHUB_URL
  git pull origin master
  echo "-----> Finished setting up git"
fi

echo "-----> Purging cache"
rm -rf $cache/*
